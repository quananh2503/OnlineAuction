{{#section 'css'}}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/5.5.2/css/fileinput.min.css">
<style>
    .seller-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid #eee;
    }

    .seller-header {
        border-bottom: 1px solid #eee;
        padding: 20px;
        margin-bottom: 20px;
    }

    .form-label {
        font-weight: 600;
        color: #333;
    }

    .text-muted-sm {
        font-size: 0.85rem;
        color: #6c757d;
    }

    /* Image Upload Styles */
    #drop-zone {
        border-color: #dee2e6 !important;
    }

    #drop-zone.drag-over {
        border-color: #0d6efd !important;
        background: #e7f1ff !important;
    }

    .image-preview-item {
        position: relative;
        width: 120px;
        height: 120px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        cursor: grab;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .image-preview-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .image-preview-item.dragging {
        opacity: 0.5;
        cursor: grabbing;
    }

    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .image-preview-item .remove-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .image-preview-item:hover .remove-btn {
        opacity: 1;
    }

    .image-preview-item .avatar-badge {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(25, 135, 84, 0.9);
        color: white;
        font-size: 10px;
        text-align: center;
        padding: 3px;
        font-weight: bold;
    }

    .image-preview-item .order-badge {
        position: absolute;
        top: 4px;
        left: 4px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{{/section}}

<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="seller-card p-4">
            <div class="seller-header">
                <h2 class="fw-bold text-warning"><i class="fas fa-gavel me-2"></i>Đăng Sản Phẩm Mới</h2>
                <p class="text-muted mb-0">Đăng bán sản phẩm của bạn để tiếp cận hàng ngàn người mua tiềm năng.</p>
            </div>

            <form action="/seller/products" method="POST" enctype="multipart/form-data" id="createProductForm">

                <!-- Basic Info -->
                <div class="mb-4">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">Thông tin cơ bản</h5>

                    <div class="mb-3">
                        <label for="name" class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" required
                            placeholder="Ví dụ: Đồng hồ cơ cổ điển...">
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="parent_category" class="form-label">Danh mục lớn <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="parent_category">
                                <option value="">-- Chọn danh mục lớn --</option>
                                {{#each categories}}
                                <option value="{{this.id}}">{{this.name}}</option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="category_id" class="form-label">Danh mục nhỏ <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="category_id" name="category_id" required disabled>
                                <option value="">-- Vui lòng chọn danh mục lớn trước --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Images -->
                <div class="mb-4">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">Hình ảnh sản phẩm</h5>
                    <p class="text-muted-sm">Cần tối thiểu 3 ảnh. Ảnh đầu tiên sẽ là ảnh đại diện. Kéo thả để sắp xếp
                        lại thứ tự.</p>

                    <div class="mb-3">
                        <label for="images" class="form-label">Tải ảnh lên <span class="text-danger">*</span></label>

                        <!-- Drop zone -->
                        <div id="drop-zone" class="border border-2 border-dashed rounded-3 p-4 text-center mb-3"
                            style="background: #fafafa; cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                            <p class="mb-1 fw-bold">Kéo thả ảnh vào đây</p>
                            <p class="text-muted small mb-2">hoặc</p>
                            <button type="button" class="btn btn-outline-primary btn-sm"
                                onclick="document.getElementById('images').click()">
                                <i class="fas fa-folder-open me-1"></i>Chọn từ máy tính
                            </button>
                            <p class="text-muted small mt-2 mb-0">Hỗ trợ JPG, PNG, GIF. Tối đa 10 ảnh, mỗi ảnh tối đa
                                5MB.</p>
                        </div>

                        <input type="file" class="d-none" id="images" name="images" multiple accept="image/*">

                        <!-- Image count indicator -->
                        <div id="image-count" class="mb-2" style="display: none;">
                            <span class="badge bg-primary me-2"><i class="fas fa-images me-1"></i><span
                                    id="count-number">0</span>/10 ảnh</span>
                            <span id="count-status" class="badge bg-danger">Cần thêm ít nhất 3 ảnh</span>
                            <button type="button" class="btn btn-outline-danger btn-sm ms-2" onclick="clearAllImages()">
                                <i class="fas fa-trash me-1"></i>Xóa tất cả
                            </button>
                        </div>

                        <!-- Image preview container with sortable -->
                        <div id="image-preview-container" class="d-flex flex-wrap gap-2 mt-3"></div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="mb-4">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">Thiết lập giá & Đấu giá</h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ends_at" class="form-label">Thời gian kết thúc <span
                                    class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="ends_at" name="ends_at" required>
                            <div class="form-text">Chọn thời điểm kết thúc đấu giá (phải ở tương lai).</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="starting_price" class="form-label">Giá khởi điểm <span
                                    class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="starting_price" name="starting_price"
                                    min="0" step="1000" required>
                                <span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="price_step" class="form-label">Bước giá <span
                                    class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="price_step" name="price_step" min="0"
                                    step="1000" required>
                                <span class="input-group-text">VNĐ</span>
                            </div>
                            <div class="form-text">Mức tăng tối thiểu cho mỗi lần đặt giá.</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="buy_now_price" class="form-label">Giá mua ngay (Tùy chọn)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="buy_now_price" name="buy_now_price"
                                    min="0" step="1000">
                                <span class="input-group-text">VNĐ</span>
                            </div>
                            <div class="form-text">Người mua có thể mua ngay lập tức với giá này.</div>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-4">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">Mô tả chi tiết</h5>
                    <div class="mb-3">
                        <label for="description" class="form-label">Nội dung mô tả <span
                                class="text-danger">*</span></label>
                        <textarea class="form-control" id="description" name="description" rows="6"></textarea>
                    </div>
                </div>

                <!-- Settings -->
                <div class="mb-4">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">Cấu hình nâng cao</h5>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="auto_extend" name="auto_extend" value="true"
                            checked>
                        <label class="form-check-label fw-bold" for="auto_extend">Tự động gia hạn</label>
                        <div class="text-muted-sm">Nếu có lượt đấu giá mới trong 5 phút cuối, thời gian kết thúc sẽ được
                            cộng thêm 10 phút.</div>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="allow_unrated" name="allow_unrated"
                            value="true" checked>
                        <label class="form-check-label fw-bold" for="allow_unrated">Cho phép người chưa có đánh
                            giá</label>
                        <div class="text-muted-sm">Nếu tắt, những người dùng chưa có lịch sử đánh giá sẽ không thể tham
                            gia đấu giá sản phẩm này.</div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="d-flex justify-content-end gap-3 mt-5">
                    <a href="/seller/products/active" class="btn btn-outline-secondary px-4">Hủy bỏ</a>
                    <button type="submit" class="btn btn-warning px-5 fw-bold">Đăng Bán Ngay</button>
                </div>

            </form>
        </div>
    </div>
</div>

{{#section 'js'}}
<script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>
<script>
    let editor;
    ClassicEditor
        .create(document.querySelector('#description'))
        .then(newEditor => {
            editor = newEditor;
        })
        .catch(error => {
            console.error(error);
        });

    // Category handling
    const categoriesData = {{{ categoriesJson }}};
    const parentSelect = document.getElementById('parent_category');
    const childSelect = document.getElementById('category_id');

    parentSelect.addEventListener('change', function () {
        const parentId = parseInt(this.value);

        // Reset child select
        childSelect.innerHTML = '<option value="">-- Chọn danh mục nhỏ --</option>';
        childSelect.disabled = true;

        if (parentId) {
            const parentCategory = categoriesData.find(c => c.id === parentId);
            if (parentCategory) {
                if (parentCategory.children && parentCategory.children.length > 0) {
                    parentCategory.children.forEach(child => {
                        const option = document.createElement('option');
                        option.value = child.id;
                        option.textContent = child.name;
                        childSelect.appendChild(option);
                    });
                    childSelect.disabled = false;
                } else {
                    // Nếu không có danh mục con, cho phép chọn chính danh mục cha
                    const option = document.createElement('option');
                    option.value = parentCategory.id;
                    option.textContent = parentCategory.name;
                    childSelect.appendChild(option);
                    childSelect.disabled = false;
                }
            }
        } else {
            childSelect.innerHTML = '<option value="">-- Vui lòng chọn danh mục lớn trước --</option>';
        }
    });

    // ==================== IMAGE UPLOAD HANDLING ====================
    let selectedFiles = []; // Store files as array for manipulation
    const fileInput = document.getElementById('images');
    const dropZone = document.getElementById('drop-zone');
    const previewContainer = document.getElementById('image-preview-container');
    const imageCountDiv = document.getElementById('image-count');
    const countNumber = document.getElementById('count-number');
    const countStatus = document.getElementById('count-status');

    // Drag & Drop Events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
    });

    dropZone.addEventListener('drop', handleDrop, false);
    dropZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', function () {
        addFiles(Array.from(this.files));
    });

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = Array.from(dt.files).filter(f => f.type.startsWith('image/'));
        addFiles(files);
    }

    function addFiles(newFiles) {
        // Filter valid images and check size (5MB max)
        const validFiles = newFiles.filter(f => {
            if (!f.type.startsWith('image/')) {
                alert(`${f.name} không phải là file ảnh!`);
                return false;
            }
            if (f.size > 5 * 1024 * 1024) {
                alert(`${f.name} vượt quá 5MB!`);
                return false;
            }
            return true;
        });

        // Check max 10 images
        const remaining = 10 - selectedFiles.length;
        if (validFiles.length > remaining) {
            alert(`Chỉ có thể thêm ${remaining} ảnh nữa (tối đa 10 ảnh).`);
            validFiles.splice(remaining);
        }

        selectedFiles = selectedFiles.concat(validFiles);
        updatePreview();
        updateFileInput();
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        updatePreview();
        updateFileInput();
    }

    function clearAllImages() {
        selectedFiles = [];
        updatePreview();
        updateFileInput();
    }

    function updateFileInput() {
        // Create a new DataTransfer to update the file input
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    }

    function updatePreview() {
        previewContainer.innerHTML = '';

        // Update count indicator
        const count = selectedFiles.length;
        countNumber.textContent = count;

        if (count > 0) {
            imageCountDiv.style.display = 'block';
            if (count >= 3) {
                countStatus.className = 'badge bg-success';
                countStatus.innerHTML = '<i class="fas fa-check me-1"></i>Đủ ảnh';
            } else {
                countStatus.className = 'badge bg-danger';
                countStatus.textContent = `Cần thêm ${3 - count} ảnh nữa`;
            }
        } else {
            imageCountDiv.style.display = 'none';
        }

        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const div = document.createElement('div');
                div.className = 'image-preview-item';
                div.draggable = true;
                div.dataset.index = index;

                div.innerHTML = `
                    <img src="${e.target.result}" alt="Preview ${index + 1}">
                    <span class="order-badge">${index + 1}</span>
                    <button type="button" class="remove-btn" onclick="removeFile(${index})" title="Xóa ảnh">
                        <i class="fas fa-times"></i>
                    </button>
                    ${index === 0 ? '<div class="avatar-badge"><i class="fas fa-star me-1"></i>Ảnh đại diện</div>' : ''}
                `;

                // Drag & Drop for reordering
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('drop', handleReorderDrop);
                div.addEventListener('dragend', handleDragEnd);

                previewContainer.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }

    // Reorder drag & drop
    let draggedIndex = null;

    function handleDragStart(e) {
        draggedIndex = parseInt(this.dataset.index);
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }

    function handleReorderDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        const targetIndex = parseInt(this.dataset.index);

        if (draggedIndex !== null && draggedIndex !== targetIndex) {
            // Swap files
            const draggedFile = selectedFiles[draggedIndex];
            selectedFiles.splice(draggedIndex, 1);
            selectedFiles.splice(targetIndex, 0, draggedFile);
            updatePreview();
            updateFileInput();
        }
    }

    function handleDragEnd() {
        this.classList.remove('dragging');
        draggedIndex = null;
    }

    // Set min datetime for ends_at
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('ends_at').min = now.toISOString().slice(0, 16);

    // Form Validation
    document.getElementById('createProductForm').addEventListener('submit', function (e) {
        // Sync CKEditor data to textarea
        if (editor) {
            const descriptionData = editor.getData();
            document.getElementById('description').value = descriptionData;

            if (!descriptionData.trim()) {
                e.preventDefault();
                alert('Vui lòng nhập mô tả sản phẩm!');
                return;
            }
        }

        if (selectedFiles.length < 3) {
            e.preventDefault();
            alert('Vui lòng chọn ít nhất 3 ảnh cho sản phẩm!');
            // Scroll to images section
            document.getElementById('drop-zone').scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        const endsAt = new Date(document.getElementById('ends_at').value);
        if (endsAt <= new Date()) {
            e.preventDefault();
            alert('Thời gian kết thúc phải lớn hơn thời gian hiện tại!');
            return;
        }
    });
</script>
{{/section}}