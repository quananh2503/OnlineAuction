<link rel="stylesheet" href="/css/product.css">

<style>
    .product-gallery-main {
        height: 400px;
        overflow: hidden;
        position: relative;
    }

    .slideshow-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        z-index: 0;
    }

    .slideshow-image.active {
        opacity: 1;
        z-index: 1;
    }
</style>

{{!-- Top Section: Images & Main Info --}}
<div class="row g-4 mb-5">
    {{!-- Left: Images --}}
    <div class="col-lg-5">
        <div class="product-gallery-main mb-3 position-relative">
            {{#if product.gallery.length}}
            {{#each product.gallery}}
            <img src="{{this}}" alt="{{../product.name}}"
                class="img-fluid rounded shadow-sm w-100 main-product-image slideshow-image {{#if @first}}active{{/if}}"
                style="object-fit: cover; cursor: zoom-in;">
            {{/each}}
            {{else}}
            <img src="{{product.avatarUrl}}" alt="{{product.name}}"
                class="img-fluid rounded shadow-sm w-100 main-product-image slideshow-image active"
                style="object-fit: cover; cursor: zoom-in;">
            {{/if}}

            {{#if (gt product.gallery.length 1)}}
            <button
                class="btn btn-light btn-sm position-absolute top-50 start-0 translate-middle-y ms-2 gallery-nav-btn"
                id="prevBtn" style="z-index: 10; border-radius: 50%; width: 40px; height: 40px;">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="btn btn-light btn-sm position-absolute top-50 end-0 translate-middle-y me-2 gallery-nav-btn"
                id="nextBtn" style="z-index: 10; border-radius: 50%; width: 40px; height: 40px;">
                <i class="fas fa-chevron-right"></i>
            </button>
            {{/if}}
        </div>
        <div class="row g-2 product-gallery-thumbs">
            {{#each product.gallery}}
            <div class="col-3">
                <img src="{{this}}" alt="{{../product.name}}"
                    class="img-thumbnail gallery-thumb {{#if @first}}active{{/if}}"
                    style="cursor: pointer; height: 80px; object-fit: cover; transition: all 0.3s;"
                    data-image="{{this}}">
            </div>
            {{/each}}
        </div>
    </div>

    {{!-- Right: Info & Actions --}}
    <div class="col-lg-7">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <h1 class="h2 fw-bold mb-0">{{product.name}}</h1>
            {{!-- Watchlist Button --}}
            <form method="POST"
                action="{{#if product.watchlisted}}/watchlist/{{product.id}}/remove{{else}}/watchlist/{{product.id}}/add{{/if}}">
                {{#if isAuth}}
                <button class="btn btn-outline-secondary btn-sm" type="submit">
                    {{#if product.watchlisted}}<i class="fas fa-heart-broken"></i>{{else}}<i
                        class="far fa-heart"></i>{{/if}}
                </button>
                {{else}}
                <button class="btn btn-outline-secondary btn-sm" type="button" disabled>
                    <i class="far fa-heart"></i>
                </button>
                {{/if}}
            </form>
        </div>

        <div class="mb-3">
            <span class="badge bg-warning text-dark fs-6">{{product.endsRelative}}</span>
            <span class="text-muted ms-2">Lượt đấu: {{product.bidCount}}</span>
        </div>

        {{!-- Price Section --}}
        <div class="d-flex align-items-end mb-4">
            <div class="me-4">
                <div class="text-muted small text-uppercase">Giá hiện tại</div>
                <div class="text-primary fw-bold display-6">{{product.currentPriceFormatted}}</div>
            </div>
            {{#if product.buyNowPriceFormatted}}
            <div>
                <div class="text-muted small text-uppercase">Mua ngay</div>
                <div class="text-success fw-bold h4 mb-1">{{product.buyNowPriceFormatted}}</div>
            </div>
            {{/if}}
        </div>

        {{!-- Seller & Bidder Info --}}
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card bg-light border-0 h-100">
                    <div class="card-body p-3">
                        <div class="small text-muted mb-1">Người bán</div>
                        <div class="fw-bold">{{product.seller.name}}</div>
                        {{#if product.seller.ratingStars}}
                        <div class="small text-warning">
                            ★ {{product.seller.ratingStars}} <span
                                class="text-muted">({{product.seller.ratingTotal}})</span>
                        </div>
                        {{/if}}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-light border-0 h-100">
                    <div class="card-body p-3">
                        <div class="small text-muted mb-1">Bidder cao nhất</div>
                        {{#if product.highestBidder}}
                        <div class="fw-bold">{{product.highestBidder.nameMasked}}</div>
                        {{#if product.highestBidder.ratingStars}}
                        <div class="small text-warning">
                            ★ {{product.highestBidder.ratingStars}} <span
                                class="text-muted">({{product.highestBidder.ratingTotal}})</span>
                        </div>
                        {{/if}}
                        {{else}}
                        <div class="text-muted fst-italic">Chưa có</div>
                        {{/if}}
                    </div>
                </div>
            </div>
        </div>

        {{!-- Actions --}}
        {{#unless isAuth}}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-circle"></i> Bạn cần <a href="/auth/login" class="alert-link">đăng nhập</a> để
            đấu giá.
        </div>
        {{/unless}}

        {{#if product.isSeller}}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Bạn là người bán của sản phẩm này.
        </div>
        {{/if}}

        <div class="d-grid gap-2">
            {{#if product.canBid}}
            <form id="bidForm" method="POST" action="/products/{{product.id}}/bid">
                {{!-- Hidden input to store buyNowPrice for JS --}}
                <input type="hidden" id="buyNowPriceData"
                    value="{{#if product.buyNowPriceValue}}{{product.buyNowPriceValue}}{{else}}Infinity{{/if}}">
                <div class="input-group input-group-lg">
                    <span class="input-group-text bg-white text-muted">$</span>
                    <input type="number" step="{{product.priceStepRaw}}" min="{{product.suggestedBidValue}}"
                        value="{{product.suggestedBidValue}}" name="amount" id="bidAmount" class="form-control fw-bold"
                        required>
                    <button class="btn btn-primary px-4" type="submit">Đặt giá</button>
                </div>
                <div class="form-text mt-1">
                    Bước giá: {{product.priceStep}} | Tối thiểu: {{product.suggestedBidFormatted}}
                </div>
            </form>
            {{/if}}

            {{#if product.canBuyNow}}
            <form id="buyNowForm" method="POST" action="/products/{{product.id}}/buy-now">
                <button class="btn btn-outline-success btn-lg w-100" type="button" id="btnBuyNow">
                    Mua ngay với giá {{product.buyNowPriceFormatted}}
                </button>
            </form>
            {{/if}}
        </div>

        {{!-- Image Gallery & Lightbox Script --}}
        <script>
            (function () {
                let currentIndex = 0;

                document.addEventListener('DOMContentLoaded', function () {
                    const slideshowImages = document.querySelectorAll('.slideshow-image');
                    const thumbnails = document.querySelectorAll('.gallery-thumb');
                    const prevBtn = document.getElementById('prevBtn');
                    const nextBtn = document.getElementById('nextBtn');
                    const lightbox = document.getElementById('imageLightbox');
                    const lightboxImage = document.getElementById('lightboxImage');
                    const lightboxPrev = document.getElementById('lightboxPrev');
                    const lightboxNext = document.getElementById('lightboxNext');
                    const closeLightbox = document.getElementById('closeLightbox');

                    // Build gallery array from slideshow images
                    const gallery = Array.from(slideshowImages).map(img => img.src);

                    // Update main image with fade effect
                    function updateMainImage(index) {
                        if (gallery.length === 0) return;
                        if (index < 0) index = gallery.length - 1;
                        if (index >= gallery.length) index = 0;
                        currentIndex = index;

                        // Update slideshow images - fade effect
                        slideshowImages.forEach((img, i) => {
                            if (i === index) {
                                img.classList.add('active');
                            } else {
                                img.classList.remove('active');
                            }
                        });

                        if (lightboxImage) lightboxImage.src = gallery[index];

                        // Update active thumbnail
                        thumbnails.forEach((thumb, i) => {
                            if (i === index) {
                                thumb.classList.add('active');
                                thumb.style.border = '3px solid #0d6efd';
                                thumb.style.opacity = '1';
                            } else {
                                thumb.classList.remove('active');
                                thumb.style.border = '';
                                thumb.style.opacity = '0.7';
                            }
                        });
                    }

                    // Thumbnail click
                    thumbnails.forEach((thumb, index) => {
                        thumb.addEventListener('click', function () {
                            updateMainImage(index);
                        });
                    });

                    // Prev/Next buttons
                    if (prevBtn) {
                        prevBtn.addEventListener('click', function (e) {
                            e.stopPropagation();
                            updateMainImage(currentIndex - 1);
                        });
                    }

                    if (nextBtn) {
                        nextBtn.addEventListener('click', function (e) {
                            e.stopPropagation();
                            updateMainImage(currentIndex + 1);
                        });
                    }

                    // Lightbox functionality
                    function openLightbox() {
                        if (lightbox) {
                            lightbox.style.display = 'flex';
                            if (lightboxImage) lightboxImage.src = gallery[currentIndex];
                            document.body.style.overflow = 'hidden';
                        }
                    }

                    function closeLightboxFunc() {
                        if (lightbox) {
                            lightbox.style.display = 'none';
                            document.body.style.overflow = '';
                        }
                    }

                    // Click main image to open lightbox
                    slideshowImages.forEach(img => {
                        img.addEventListener('click', openLightbox);
                    });

                    // Lightbox navigation
                    if (lightboxPrev) {
                        lightboxPrev.addEventListener('click', function (e) {
                            e.stopPropagation();
                            updateMainImage(currentIndex - 1);
                        });
                    }

                    if (lightboxNext) {
                        lightboxNext.addEventListener('click', function (e) {
                            e.stopPropagation();
                            updateMainImage(currentIndex + 1);
                        });
                    }

                    if (closeLightbox) {
                        closeLightbox.addEventListener('click', closeLightboxFunc);
                    }

                    // Close lightbox on background click
                    if (lightbox) {
                        lightbox.addEventListener('click', function (e) {
                            if (e.target === lightbox) {
                                closeLightboxFunc();
                            }
                        });
                    }

                    // Keyboard navigation
                    document.addEventListener('keydown', function (e) {
                        if (lightbox && lightbox.style.display === 'flex') {
                            if (e.key === 'ArrowLeft') {
                                updateMainImage(currentIndex - 1);
                            } else if (e.key === 'ArrowRight') {
                                updateMainImage(currentIndex + 1);
                            } else if (e.key === 'Escape') {
                                closeLightboxFunc();
                            }
                        }
                    });
                });
            })();
        </script>

        {{!-- Lightbox Modal --}}
        <div id="imageLightbox"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; align-items: center; justify-content: center; cursor: pointer;">
            <button id="closeLightbox"
                style="position: absolute; top: 20px; right: 30px; background: none; border: none; color: white; font-size: 40px; cursor: pointer; z-index: 10000; width: 50px; height: 50px; line-height: 50px; text-align: center;"
                title="Đóng (ESC)">
                &times;
            </button>
            {{#if (gt product.gallery.length 1)}}
            <button id="lightboxPrev"
                style="position: absolute; left: 30px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; font-size: 30px; padding: 15px 20px; cursor: pointer; border-radius: 50%; z-index: 10000; transition: background 0.3s;"
                onmouseover="this.style.background='rgba(255,255,255,0.4)'"
                onmouseout="this.style.background='rgba(255,255,255,0.2)'" title="Ảnh trước (←)">
                &#8249;
            </button>
            <button id="lightboxNext"
                style="position: absolute; right: 30px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; font-size: 30px; padding: 15px 20px; cursor: pointer; border-radius: 50%; z-index: 10000; transition: background 0.3s;"
                onmouseover="this.style.background='rgba(255,255,255,0.4)'"
                onmouseout="this.style.background='rgba(255,255,255,0.2)'" title="Ảnh sau (→)">
                &#8250;
            </button>
            {{/if}}
            <img id="lightboxImage" src="{{product.avatarUrl}}" alt="{{product.name}}"
                style="max-width: 90%; max-height: 90%; object-fit: contain; cursor: default;"
                onclick="event.stopPropagation();">
        </div>

        {{!-- SweetAlert2 & Custom Script --}}
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Check for error in URL
                const urlParams = new URLSearchParams(window.location.search);
                const errorMsg = urlParams.get('error');
                if (errorMsg) {
                    Swal.fire({
                        title: 'Thông báo',
                        text: errorMsg,
                        icon: 'warning',
                        confirmButtonColor: '#0d6efd'
                    });
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                const bidForm = document.getElementById('bidForm');
                const buyNowForm = document.getElementById('buyNowForm');
                const btnBuyNow = document.getElementById('btnBuyNow');

                if (bidForm) {
                    bidForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        const amountInput = document.getElementById('bidAmount');
                        const amount = parseFloat(amountInput.value);
                        // Read from hidden input to avoid Handlebars syntax errors in script
                        const buyNowPrice = parseFloat(document.getElementById('buyNowPriceData').value);
                        const formattedBuyNow = "{{product.buyNowPriceFormatted}}";

                        if (amount >= buyNowPrice) {
                            Swal.fire({
                                title: 'Xác nhận mua ngay?',
                                text: `Giá bạn đặt (${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount)}) cao hơn hoặc bằng giá mua ngay. Bạn có muốn mua ngay sản phẩm này không?`,
                                icon: 'question',
                                showCancelButton: true,
                                confirmButtonText: 'Đồng ý mua ngay',
                                cancelButtonText: 'Hủy',
                                confirmButtonColor: '#198754',
                                cancelButtonColor: '#6c757d'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    if (buyNowForm) buyNowForm.submit();
                                }
                            });
                        } else {
                            Swal.fire({
                                title: 'Xác nhận đặt giá?',
                                text: `Bạn muốn đặt giá: ${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount)}`,
                                icon: 'info',
                                showCancelButton: true,
                                confirmButtonText: 'Đặt giá',
                                cancelButtonText: 'Hủy',
                                confirmButtonColor: '#0d6efd',
                                cancelButtonColor: '#6c757d'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    bidForm.submit();
                                }
                            });
                        }
                    });
                }

                if (btnBuyNow && buyNowForm) {
                    btnBuyNow.addEventListener('click', function () {
                        Swal.fire({
                            title: 'Xác nhận mua ngay?',
                            text: "Bạn có chắc chắn muốn mua ngay sản phẩm này?",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Mua ngay',
                            cancelButtonText: 'Hủy',
                            confirmButtonColor: '#198754',
                            cancelButtonColor: '#6c757d'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                buyNowForm.submit();
                            }
                        });
                    });
                }
            });
        </script>
    </div>
</div>

{{!-- Middle Section: Description & Sidebar --}}
<div class="row g-4">
    {{!-- Left: Description & Q&A --}}
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold text-primary">Mô tả sản phẩm</h5>
            </div>
            <div class="card-body">
                {{{product.description}}}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold text-primary">Hỏi đáp</h5>
                {{#if isAuth}}
                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse"
                    data-bs-target="#askForm">
                    Đặt câu hỏi
                </button>
                {{/if}}
            </div>
            <div class="card-body">
                {{#if isAuth}}
                <div class="collapse mb-3" id="askForm">
                    <form method="POST" action="/products/{{product.id}}/questions"
                        onsubmit="return confirm('Gửi câu hỏi?');">
                        <div class="input-group">
                            <input type="text" name="content" class="form-control" placeholder="Nhập câu hỏi của bạn..."
                                required>
                            <button class="btn btn-primary" type="submit">Gửi</button>
                        </div>
                    </form>
                </div>
                {{/if}}

                <div class="question-list">
                    {{#if questions.length}}
                    {{#each questions}}
                    <div class="mb-3 pb-3 border-bottom last-no-border">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">{{askerName}}</span>
                            <span class="small text-muted">{{createdAt}}</span>
                        </div>
                        <p class="mb-2">{{content}}</p>

                        {{#if answerContent}}
                        <div class="bg-light p-3 rounded-3 ms-4 border-start border-4 border-primary">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="fw-bold text-primary">Người bán trả lời</span>
                                <span class="small text-muted">{{answeredAt}}</span>
                            </div>
                            <p class="mb-0">{{answerContent}}</p>
                        </div>
                        {{else}}
                        {{#if ../product.isSeller}}
                        <form method="POST" action="/products/{{../product.id}}/questions/{{id}}/answer"
                            class="ms-4 mt-2">
                            <div class="input-group input-group-sm">
                                <input type="text" name="answer" class="form-control" placeholder="Trả lời..." required>
                                <button class="btn btn-secondary" type="submit">Gửi</button>
                            </div>
                        </form>
                        {{else}}
                        <div class="ms-4 text-muted small fst-italic">Chưa có câu trả lời</div>
                        {{/if}}
                        {{/if}}
                    </div>
                    {{/each}}
                    {{else}}
                    <div class="text-center text-muted py-3">Chưa có câu hỏi nào.</div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>

    {{!-- Right: Sidebar (History & Details) --}}
    <div class="col-lg-4">
        {{!-- Auction Details --}}
        <div class="card mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">Thông tin đấu giá</h5>
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                    <span class="text-muted">Ngày đăng</span>
                    <span class="fw-medium">{{product.postedAt}}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span class="text-muted">Kết thúc</span>
                    <span class="fw-medium">{{product.endsRelative}}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span class="text-muted">Giá khởi điểm</span>
                    <span class="fw-medium">{{product.startingPriceFormatted}}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span class="text-muted">Bước giá</span>
                    <span class="fw-medium">{{product.priceStep}}</span>
                </li>
            </ul>
        </div>

        {{!-- Bid History --}}
        <div class="card">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">Lịch sử đấu giá</h5>
            </div>
            <div class="card-body p-0">
                {{#if bidHistory.length}}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">Người đấu</th>
                                <th>Giá</th>
                                <th class="text-end pe-3">Thời gian</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each bidHistory}}
                            <tr>
                                <td class="ps-3">{{bidder}}</td>
                                <td class="fw-bold text-primary">{{priceFormatted}}</td>
                                <td class="text-end pe-3 small text-muted">{{time}}</td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
                {{else}}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-history fa-2x mb-2"></i>
                    <p class="mb-0">Chưa có lượt đấu giá nào.</p>
                </div>
                {{/if}}
            </div>
        </div>
    </div>
</div>

{{!-- Bottom: Related Products --}}
<div class="mt-5">
    <h3 class="mb-4 fw-bold border-bottom pb-2">Sản phẩm liên quan</h3>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
        {{#if relatedProducts.length}}
        {{#each relatedProducts}}
        <div class="col">
            <div class="card h-100 shadow-sm hover-shadow transition">
                <div class="position-relative">
                    <img src="{{image}}" class="card-img-top" alt="{{name}}" style="height: 200px; object-fit: cover;">
                    {{#if isNew}}
                    <span class="position-absolute top-0 start-0 badge bg-danger m-2">Mới</span>
                    {{/if}}
                </div>
                <div class="card-body">
                    <h6 class="card-title text-truncate"><a href="/products/{{id}}"
                            class="text-decoration-none text-dark stretched-link">{{name}}</a></h6>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <span class="fw-bold text-primary">{{priceFormatted}}</span>
                        <small class="text-muted">{{endsText}}</small>
                    </div>
                </div>
            </div>
        </div>
        {{/each}}
        {{else}}
        <div class="col-12">
            <p class="text-muted">Không có sản phẩm liên quan.</p>
        </div>
        {{/if}}
    </div>
</div>