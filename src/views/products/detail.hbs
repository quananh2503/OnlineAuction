<link rel="stylesheet" href="/css/product.css">

<div class="product-hero p-4">
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="product-gallery-main mb-3">
                <img src="{{product.avatarUrl}}" alt="{{product.name}}" class="img-fluid shadow-sm">
            </div>
            <div class="row g-2 product-gallery-thumbs">
                {{#each product.gallery}}
                <div class="col-3">
                    <img src="{{this}}" alt="{{../product.name}}">
                </div>
                {{/each}}
            </div>
        </div>
        <div class="col-lg-6">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h2 class="mb-1">{{product.name}}</h2>
                    <p class="text-muted mb-0">Danh mục: {{product.categoryName}}</p>
                </div>
                <form method="POST"
                    action="{{#if product.watchlisted}}/watchlist/{{product.id}}/remove{{else}}/watchlist/{{product.id}}/add{{/if}}">
                    {{#if isAuth}}
                    <button class="btn btn-outline-secondary btn-sm" type="submit">
                        {{#if product.watchlisted}}<i class="fas fa-heart-broken"></i> Bỏ yêu thích{{else}}<i
                            class="far fa-heart"></i> Lưu yêu thích{{/if}}
                    </button>
                    {{else}}
                    <button class="btn btn-outline-secondary btn-sm" type="button" disabled>
                        <i class="far fa-heart"></i> Đăng nhập để lưu
                    </button>
                    {{/if}}
                </form>
            </div>

            <div class="card product-price-card mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-uppercase small text-white-50">Giá hiện tại</div>
                            <div class="current-price">{{product.currentPriceFormatted}}</div>
                        </div>
                        {{#if product.buyNowPriceFormatted}}
                        <div>
                            <div class="text-uppercase small text-white-50">Mua ngay</div>
                            <div class="h4 mb-0">{{product.buyNowPriceFormatted}}</div>
                        </div>
                        {{/if}}
                    </div>
                    <div class="mt-3 small text-white-75">
                        <div>Bước giá: {{product.priceStep}}</div>
                        <div>Giá đề nghị: {{product.suggestedBidFormatted}}</div>
                        <div>Lượt đấu: {{product.bidCount}}</div>
                    </div>
                </div>
            </div>

            <ul class="product-meta-list small mb-3">
                <li><strong>Người bán:</strong> {{product.seller.name}}
                    {{#if product.seller.ratingStars}}
                    <span class="text-warning">★ {{product.seller.ratingStars}}</span>
                    ({{product.seller.ratingTotal}} đánh giá)
                    {{/if}}
                </li>
                {{#if product.highestBidder}}
                <li><strong>Bidder dẫn đầu:</strong> {{product.highestBidder.nameMasked}}
                    {{#if product.highestBidder.ratingStars}}
                    <span class="text-warning">★ {{product.highestBidder.ratingStars}}</span>
                    ({{product.highestBidder.ratingTotal}} đánh giá)
                    {{/if}}
                </li>
                {{/if}}
                <li><strong>Đăng lúc:</strong> {{product.postedAt}}</li>
                <li><strong>Kết thúc:</strong> {{product.endsDisplay}}</li>
            </ul>

            {{#unless isAuth}}
            <div class="alert alert-warning">Bạn cần đăng nhập để thực hiện mua ngay hoặc đặt giá.</div>
            {{/unless}}
            {{#if product.isSeller}}
            <div class="alert alert-info">Bạn là người bán của sản phẩm này.</div>
            {{/if}}

            <div class="bid-actions">
                {{#if product.canBid}}
                <form method="POST" action="/products/{{product.id}}/bid"
                    onsubmit="return confirm('Xác nhận đặt giá?');" class="card card-body mb-2">
                    <label class="form-label">Nhập giá của bạn</label>
                    <div class="input-group mb-2">
                        <input type="number" step="{{product.priceStepRaw}}" min="{{product.suggestedBidValue}}"
                            value="{{product.suggestedBidValue}}" name="amount" class="form-control" required>
                        <button class="btn btn-dark" type="submit"><i class="fas fa-gavel"></i> Đấu giá</button>
                    </div>
                    <small class="text-muted">Tối thiểu: {{product.suggestedBidFormatted}}</small>
                </form>
                {{/if}}

                {{#if product.canBuyNow}}
                <form method="POST" action="/products/{{product.id}}/buy-now"
                    onsubmit="return confirm('Xác nhận mua ngay sản phẩm này?');">
                    <button class="btn btn-success w-100" type="submit"><i class="fas fa-bolt"></i> Mua ngay
                        {{product.buyNowPriceFormatted}}</button>
                </form>
                {{/if}}
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <section class="mb-4">
            <h4>Mô tả sản phẩm</h4>
            <p>{{product.description}}</p>
        </section>

        <section class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4>Câu hỏi &amp; Trả lời</h4>
                {{#if isAuth}}
                <form class="d-flex gap-2" method="POST" action="/products/{{product.id}}/questions"
                    onsubmit="return confirm('Gửi câu hỏi đến người bán?');">
                    <input type="text" name="content" class="form-control" placeholder="Nội dung câu hỏi"
                        required>
                    <button class="btn btn-primary" type="submit">Gửi</button>
                </form>
                {{/if}}
            </div>
            {{#unless isAuth}}
            <div class="alert alert-secondary">Đăng nhập để đặt câu hỏi cho người bán.</div>
            {{/unless}}
            <div class="question-list">
                {{#if questions.length}}
                {{#each questions}}
                <div class="question-item">
                    <div class="fw-semibold">{{askerName}} hỏi <span class="text-muted">({{createdAt}})</span></div>
                    <p class="mb-1">{{content}}</p>
                    {{#if answerContent}}
                    <div class="bg-light p-2 rounded">
                        <div class="small text-muted">Người bán trả lời {{#if answeredAt}}({{answeredAt}}){{/if}}</div>
                        <p class="mb-0">{{answerContent}}</p>
                    </div>
                    {{else}}
                    {{#if ../product.isSeller}}
                    <form method="POST" action="/products/{{../product.id}}/questions/{{id}}/answer"
                        class="mt-2" onsubmit="return confirm('Gửi câu trả lời?');">
                        <div class="input-group">
                            <input type="text" name="answer" class="form-control" placeholder="Nhập câu trả lời"
                                required>
                            <button class="btn btn-outline-primary" type="submit">Trả lời</button>
                        </div>
                    </form>
                    {{else}}
                    <div class="text-muted small">Đang chờ người bán trả lời...</div>
                    {{/if}}
                    {{/if}}
                </div>
                {{/each}}
                {{else}}
                <div class="text-muted">Chưa có câu hỏi nào.</div>
                {{/if}}
            </div>
        </section>

        <section>
            <h4>Lịch sử đấu giá</h4>
            {{#if bidHistory.length}}
            <div class="table-responsive">
                <table class="table table-sm bid-history-table">
                    <thead>
                        <tr>
                            <th>Thời điểm</th>
                            <th>Người mua</th>
                            <th>Giá</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each bidHistory}}
                        <tr>
                            <td>{{time}}</td>
                            <td>{{bidder}}</td>
                            <td>{{priceFormatted}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
            {{else}}
            <div class="text-muted">Chưa có lượt đấu giá nào.</div>
            {{/if}}
        </section>
    </div>

    <div class="col-lg-4">
        <section class="mb-4">
            <h4>Sản phẩm liên quan</h4>
            <div class="row row-cols-1 g-3 related-products">
                {{#if relatedProducts.length}}
                {{#each relatedProducts}}
                <div class="col">
                    <div class="card">
                        <img src="{{image}}" class="card-img-top" alt="{{name}}">
                        <div class="card-body">
                            <h6 class="card-title text-truncate">{{name}}</h6>
                            <p class="mb-1 fw-semibold">{{priceFormatted}}</p>
                            <p class="text-muted small">Còn lại: {{endsText}}</p>
                            <a href="/products/{{id}}" class="btn btn-outline-primary btn-sm w-100">Xem</a>
                        </div>
                    </div>
                </div>
                {{/each}}
                {{else}}
                <div class="text-muted">Chưa có sản phẩm tương tự.</div>
                {{/if}}
            </div>
        </section>
    </div>
</div>