<div class="row">
    <aside class="col-md-3">
        {{> categoryMenu}}
    </aside>
    <div class="col-md-9">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
                <form class="d-flex" action="/products" method="GET">
                    <input type="hidden" name="category" value="{{category}}">
                    <input name="q" value="{{q}}" class="form-control me-2" placeholder="Tìm trong danh mục...">
                    <button class="btn btn-outline-secondary" type="submit"><i class="fa fa-search"></i></button>
                </form>
            </div>
            <div class="d-flex align-items-center">
                <label class="me-2">Sắp xếp</label>
                <select id="sortSel" class="form-select form-select-sm" onchange="location = this.value">
                    <option value="/products?q={{q}}&category={{category}}&sort=end_desc" {{#if (eq sort 'end_desc'
                        )}}selected{{/if}}>Thời gian kết thúc (gần nhất)</option>
                    <option value="/products?q={{q}}&category={{category}}&sort=price_asc" {{#if (eq sort 'price_asc'
                        )}}selected{{/if}}>Giá tăng dần</option>
                </select>
            </div>
        </div>

        <div class="product-grid">
            {{#each products}}
            <article class="card product-card">
                <img src="{{image}}" class="card-img-top product-img" alt="{{title}}">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{title}}</h5>
                    <p class="mb-1 text-muted small">Người bán: {{seller.name}}</p>
                    <p class="mb-1"><strong>{{currentPriceFormatted}}₫</strong></p>
                    {{#if buyNowPrice}}<p class="mb-1 text-success small">Mua ngay: {{buyNowPrice}}₫</p>{{/if}}
                    <p class="mb-1 small text-secondary">Đăng: {{createdAt}}</p>
                    <p class="mb-1 small">Thời gian còn lại: <strong>{{remainingText}}</strong></p>
                    <p class="mb-2 small">Lượt đấu: <strong>{{bidsCount}}</strong></p>
                    <div class="mt-auto d-flex justify-content-between align-items-center">
                        <a class="btn btn-sm btn-outline-primary" href="/products/{{id}}">Xem chi tiết</a>
                        <div class="d-flex align-items-center gap-2">
                            {{#if isNew}}<span class="badge bg-warning text-dark">Mới</span>{{/if}}
                            <button class="btn btn-outline-secondary btn-watchlist" 
                                    data-product-id="{{id}}" 
                                    title="Thêm vào danh sách theo dõi">
                                <i class="fas fa-bookmark"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </article>
            {{/each}}
        </div>

        <!-- Pagination -->
        <nav class="mt-4" aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {{#if (gt page 1)}}
                <li class="page-item"><a class="page-link"
                        href="/products?page={{subtract page 1}}&q={{q}}&category={{category}}&sort={{sort}}">«</a></li>
                {{/if}}
                {{#each (range 1 totalPages)}}
                <li class="page-item {{#ifEquals this ../page}}active{{/ifEquals}}"><a class="page-link"
                        href="/products?page={{this}}&q={{../q}}&category={{../category}}&sort={{../sort}}">{{this}}</a>
                </li>
                {{/each}}
                {{#if (lt page totalPages)}}
                <li class="page-item"><a class="page-link"
                        href="/products?page={{add page 1}}&q={{q}}&category={{category}}&sort={{sort}}">»</a></li>
                {{/if}}
            </ul>
        </nav>
    </div>
</div>

{{! Toast notification }}
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="watchlistToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage"></div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<style>
.btn-watchlist {
    transition: all 0.3s ease;
    font-size: 1rem;
    padding: 0.375rem 0.75rem;
}

.btn-watchlist:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.toast {
    min-width: 250px;
}

.toast.bg-success .toast-body {
    color: white;
}

.toast.bg-danger .toast-body {
    color: white;
}

.toast.bg-warning .toast-body {
    color: #000;
}

.toast.bg-info .toast-body {
    color: white;
}
</style>

<script>
// AJAX Toggle Watchlist
document.addEventListener('DOMContentLoaded', function() {
    const watchlistButtons = document.querySelectorAll('.btn-watchlist');
    const toastEl = document.getElementById('watchlistToast');
    const toastMessage = document.getElementById('toastMessage');
    
    watchlistButtons.forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            
            const productId = this.dataset.productId;
            
            try {
                const response = await fetch(`/watchlist/toggle/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Hiển thị thông báo thành công
                    if (data.watchlisted) {
                        toastEl.classList.remove('bg-danger', 'bg-warning');
                        toastEl.classList.add('bg-success');
                    } else {
                        toastEl.classList.remove('bg-success', 'bg-warning');
                        toastEl.classList.add('bg-info');
                    }
                    
                    toastMessage.textContent = data.message;
                } else {
                    // Error (chưa đăng nhập)
                    toastEl.classList.remove('bg-success', 'bg-danger', 'bg-info');
                    toastEl.classList.add('bg-warning');
                    toastMessage.textContent = data.message;
                    
                    // Redirect to login after 2s
                    if (response.status === 401) {
                        setTimeout(() => {
                            window.location.href = '/auth/login';
                        }, 2000);
                    }
                }
                
                // Show toast
                const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
                
            } catch (error) {
                console.error('Error toggling watchlist:', error);
                toastEl.classList.remove('bg-success', 'bg-danger', 'bg-info');
                toastEl.classList.add('bg-warning');
                toastMessage.textContent = 'Có lỗi xảy ra, vui lòng thử lại!';
                
                const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
            }
        });
    });
});
</script>